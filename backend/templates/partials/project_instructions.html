<!-- 🔹 Project Instructions Section -->
<section class="bg-white border rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-semibold mb-1 flex items-center gap-2">
      <i data-lucide="clipboard-list" class="w-5 h-5 text-gray-600"></i>
      Project Instructions
    </h2>
    <p class="text-sm text-gray-500 mb-6">Define and run step-by-step tasks for this project.</p>
  
    <!-- Accordion Wrapper -->
    <div x-data="{ open: 'none' }" class="space-y-4">
  
<!-- Step 1: Plan -->
<div class="border rounded-md"
     x-data="{
       mode: 'view',
       valueSystem: '',
       valueUser: '',
       saved: false,
       generating: false,
       feedback: '',
       load() {
         fetch(`/project/{{ project_slug }}/instructions`)
           .then(res => res.json())
           .then(data => {
             this.valueSystem = data?.plan?.system || '';
             this.valueUser = data?.plan?.user || '';
             this.saved = !!(this.valueSystem || this.valueUser);
           });
       },
       save() {
         fetch(`/project/{{ project_slug }}/instructions`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ plan: { system: this.valueSystem, user: this.valueUser } })
         }).then(res => res.json())
           .then(res => {
             if (res.status === 'success') {
               this.saved = true;
               this.mode = 'view';
             }
           });
       },
       generatePlan() {
         this.feedback = 'Your request is being processed. Output will be available in the Plan tab soon.';
         this.generating = true;
         this.mode = 'view'; // allow interface to exit edit mode if open
         fetch(`/project/{{ project_slug }}/run-step/plan`, { method: 'POST' })
           .then(res => res.json())
           .then(data => {
             this.generating = false;
             if (data.status === 'success') {
               this.feedback = '✅ Plan generation started successfully.';
               if (window.loadProjects) window.loadProjects();
             } else {
               this.feedback = '⚠️ Error: ' + data.message;
             }
           })
           .catch(() => {
             this.generating = false;
             this.feedback = '❌ Unexpected error while triggering generation.';
           });
       }
     }"
     x-init="load()"
>
  <button @click="open = open === 'plan' ? null : 'plan'"
          class="flex justify-between items-center w-full px-4 py-3 text-left text-base font-medium hover:bg-gray-50">
    <div class="flex items-center gap-2">
      <span>Plan</span>
      <span x-show="saved" class="text-green-700 text-xs bg-green-100 font-medium px-2 py-0.5 rounded-full">
        Completed
      </span>
    </div>
    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 transform"
       :class="{ 'rotate-180': open === 'plan' }"></i>
  </button>

  <div x-show="open === 'plan'" x-collapse class="border-t px-4 py-4 text-sm text-gray-800 space-y-3">
    <!-- Button to add instructions initially -->
    <template x-if="!saved && mode === 'view'">
      <button @click="mode = 'edit'" class="border rounded px-4 py-2 text-sm flex items-center gap-2">
        <i data-lucide='plus' class="w-4 h-4"></i> Add Plan Instructions
      </button>
    </template>

    <!-- Edit mode with two textareas -->
    <template x-if="mode === 'edit'">
      <div class="space-y-3">
        <label class="block text-xs font-semibold text-gray-500">System Instructions</label>
        <textarea x-model="valueSystem" rows="4" class="w-full border rounded p-2" placeholder="Enter system-level instructions..."></textarea>

        <label class="block text-xs font-semibold text-gray-500">User Instructions</label>
        <textarea x-model="valueUser" rows="5" class="w-full border rounded p-2" placeholder="Enter user-level instructions..."></textarea>

        <div class="flex justify-end gap-2">
          <button @click="mode = 'view'" class="px-4 py-2 border text-sm rounded-md">Cancel</button>
          <button @click="save()" class="px-4 py-2 bg-gray-900 text-white text-sm rounded-md hover:bg-gray-800">
            <i data-lucide="save" class="w-4 h-4 mr-1"></i> Save
          </button>
        </div>
      </div>
    </template>

    <!-- View mode: show saved values -->
    <template x-if="saved && mode === 'view'">
      <div class="space-y-3">
        <div class="text-xs text-gray-500 font-semibold">System Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueSystem"></div>

        <div class="text-xs text-gray-500 font-semibold">User Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueUser"></div>

        <div class="flex justify-between">
          <button @click="mode = 'edit'" class="flex items-center gap-1 text-sm border px-3 py-1 rounded">
            <i data-lucide="pencil" class="w-4 h-4"></i> Edit Instructions
          </button>
          <div>
            <button
              @click="generatePlan"
              class="flex items-center gap-1 bg-black text-white text-sm px-3 py-1 rounded"
              :disabled="generating"
            >
              <template x-if="!generating">
                <span><i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Generate Plan</span>
              </template>
              <template x-if="generating">
                <span class="flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none"/></svg>
                  Generating...
                </span>
              </template>
            </button>
            <template x-if="feedback">
              <div class="mt-2 text-sm text-blue-700" x-text="feedback"></div>
            </template>
          </div>
        </div>
      </div>
    </template>
  </div>
</div>

  
  
<!-- Step 2: Write -->
<div class="border rounded-md">
  <button @click="open = open === 'write' ? null : 'write'"
          class="flex justify-between items-center w-full px-4 py-3 text-left text-base font-medium hover:bg-gray-50">
    <div class="flex items-center gap-2">
      <span>Write</span>
      <span x-show="saved" class="text-green-700 text-xs bg-green-100 font-medium px-2 py-0.5 rounded-full">
        Completed
      </span>
    </div>
    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 transform"
       :class="{ 'rotate-180': open === 'write' }"></i>
  </button>

  <div x-show="open === 'write'" x-collapse class="border-t px-4 py-4 text-sm text-gray-800"
  x-data="{
    mode: 'view',
    valueSystem: '',
    valueUser: '',
    saved: false,
    load() {
      fetch(`/project/{{ project_slug }}/instructions`)
        .then(res => res.json())
        .then(data => {
          this.valueSystem = data?.write?.system || '';
          this.valueUser = data?.write?.user || '';
          this.saved = !!(this.valueSystem || this.valueUser);
        });
    },
    save() {
      fetch(`/project/{{ project_slug }}/instructions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          write: {
            system: this.valueSystem,
            user: this.valueUser
          }
        })
      }).then(res => res.json())
        .then(res => {
          if (res.status === 'success') {
            this.saved = true;
            this.mode = 'view';
          }
        });
    },
    generating: false,
    generateWrite() {
      this.generating = true;
      fetch(`/project/{{ project_slug }}/run-step/write`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          this.generating = false;
          if (data.status === 'success') {
            alert('✅ Write generation started. Output will be available under the “Write” tab shortly.');
            if (window.loadProjects) window.loadProjects();
          } else {
            alert('⚠️ Error: ' + data.message);
          }
        })
        .catch(() => {
          this.generating = false;
          alert('❌ Unexpected error while generating Write output.');
        });
    }
  }"
  
       x-init="load()"
       class="space-y-3"
  >
    <template x-if="!saved && mode === 'view'">
      <button @click="mode = 'edit'" class="border rounded px-4 py-2 text-sm flex items-center gap-2">
        <i data-lucide='plus' class="w-4 h-4"></i> Add Write Instructions
      </button>
    </template>

    <template x-if="mode === 'edit'">
      <div class="space-y-3">
        <label class="block text-xs font-semibold text-gray-500">System Instructions</label>
        <textarea x-model="valueSystem" rows="4" class="w-full border rounded p-2" placeholder="Enter system-level instructions..."></textarea>
    
        <label class="block text-xs font-semibold text-gray-500">User Instructions</label>
        <textarea x-model="valueUser" rows="5" class="w-full border rounded p-2" placeholder="Enter user-level instructions..."></textarea>
    
        <div class="flex justify-end gap-2">
          <button @click="mode = 'view'" class="px-4 py-2 border text-sm rounded-md">Cancel</button>
          <button @click="save()" class="px-4 py-2 bg-gray-900 text-white text-sm rounded-md hover:bg-gray-800">
            <i data-lucide="save" class="w-4 h-4 mr-1"></i> Save
          </button>
        </div>
      </div>
    </template>
    

    <template x-if="saved && mode === 'view'">
      <div class="space-y-3">
        <div class="text-xs text-gray-500 font-semibold">System Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueSystem"></div>
    
        <div class="text-xs text-gray-500 font-semibold">User Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueUser"></div>
    
        <div class="flex justify-between">
          <button @click="mode = 'edit'" class="flex items-center gap-1 text-sm border px-3 py-1 rounded">
            <i data-lucide="pencil" class="w-4 h-4"></i> Edit Instructions
          </button>
          <button
          @click="generateWrite"
          class="flex items-center gap-1 bg-black text-white text-sm px-3 py-1 rounded"
          :disabled="generating"
        >
          <template x-if="!generating">
            <span><i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Generate Write</span>
          </template>
          <template x-if="generating">
            <span class="flex items-center gap-2">
              <svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none"/></svg>
              Generating...
            </span>
          </template>
        </button>
        </div>
      </div>
    </template>
    
  </div>
</div>

  
<!-- Step 3: Check -->
<div class="border rounded-md">
  <button @click="open = open === 'check' ? null : 'check'"
          class="flex justify-between items-center w-full px-4 py-3 text-left text-base font-medium hover:bg-gray-50">
    <div class="flex items-center gap-2">
      <span>Check</span>
      <span x-show="saved" class="text-green-700 text-xs bg-green-100 font-medium px-2 py-0.5 rounded-full">
        Completed
      </span>
    </div>
    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 transform"
       :class="{ 'rotate-180': open === 'check' }"></i>
  </button>

  <div x-show="open === 'check'" x-collapse class="border-t px-4 py-4 text-sm text-gray-800"
       x-data="{
  mode: 'view',
  valueSystem: '',
  valueUser: '',
  saved: false,
  generating: false,
  load() {
    fetch(`/project/{{ project_slug }}/instructions`)
      .then(res => res.json())
      .then(data => {
        this.valueSystem = data?.check?.system || '';
        this.valueUser = data?.check?.user || '';
        this.saved = !!(this.valueSystem || this.valueUser);
      });
  },
  save() {
    fetch(`/project/{{ project_slug }}/instructions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        check: {
          system: this.valueSystem,
          user: this.valueUser
        }
      })
    }).then(res => res.json())
      .then(res => {
        if (res.status === 'success') {
          this.saved = true;
          this.mode = 'view';
        }
      });
  },
  generateCheck() {
    this.generating = true;
    fetch(`/project/{{ project_slug }}/run-step/check`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        this.generating = false;
        if (data.status === 'success') {
          alert('✅ Check generation started. Output will be available under the “Check” tab shortly.');
          if (window.loadProjects) window.loadProjects();
        } else {
          alert('⚠️ Error: ' + data.message);
        }
      })
      .catch(() => {
        this.generating = false;
        alert('❌ Unexpected error while generating Check output.');
      });
  }
}"
       x-init="load()"
       class="space-y-3"
  >

    <!-- Initial Add Button -->
    <template x-if="!saved && mode === 'view'">
      <button @click="mode = 'edit'" class="border rounded px-4 py-2 text-sm flex items-center gap-2">
        <i data-lucide='plus' class="w-4 h-4"></i> Add Check Instructions
      </button>
    </template>

    <!-- Edit Mode -->
    <template x-if="mode === 'edit'">
      <div class="space-y-3">
        <label class="block text-xs font-semibold text-gray-500">System Instructions</label>
        <textarea x-model="valueSystem" rows="4" class="w-full border rounded p-2" placeholder="Enter system-level instructions..."></textarea>

        <label class="block text-xs font-semibold text-gray-500">User Instructions</label>
        <textarea x-model="valueUser" rows="5" class="w-full border rounded p-2" placeholder="Enter user-level instructions..."></textarea>

        <div class="flex justify-end gap-2">
          <button @click="mode = 'view'" class="px-4 py-2 border text-sm rounded-md">Cancel</button>
          <button @click="save()" class="px-4 py-2 bg-gray-900 text-white text-sm rounded-md hover:bg-gray-800">
            <i data-lucide="save" class="w-4 h-4 mr-1"></i> Save
          </button>
        </div>
      </div>
    </template>

    <!-- View Mode -->
    <template x-if="saved && mode === 'view'">
      <div class="space-y-3">
        <div class="text-xs text-gray-500 font-semibold">System Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueSystem"></div>

        <div class="text-xs text-gray-500 font-semibold">User Instructions</div>
        <div class="bg-gray-50 border border-gray-200 p-3 rounded whitespace-pre-wrap" x-text="valueUser"></div>

        <div class="flex justify-between">
          <button @click="mode = 'edit'" class="flex items-center gap-1 text-sm border px-3 py-1 rounded">
            <i data-lucide="pencil" class="w-4 h-4"></i> Edit Instructions
          </button>
          <button
            @click="generateCheck"
            class="flex items-center gap-1 bg-black text-white text-sm px-3 py-1 rounded"
            :disabled="generating"
          >
            <template x-if="!generating">
              <span><i data-lucide='sliders-horizontal' class="w-4 h-4"></i> Generate Check</span>
            </template>
            <template x-if="generating">
              <span class="flex items-center gap-2">
                <svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none"/></svg>
                Generating...
              </span>
            </template>
          </button>
        </div>
      </div>
    </template>

  </div>
</div>


  
    </div>
  </section>
  