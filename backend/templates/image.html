<!-- templates/image.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="flex min-h-screen bg-white text-gray-900">

  <!-- Sidebar -->
  <aside class="w-64 p-4 bg-gray-100 border-r">
    {% include 'navbar.html' %}
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto" x-data="{ selected: '{{ default_image_model }}', disabled: false, imagePreview: null }">
    <h1 class="text-3xl font-bold mb-2">üñºÔ∏è Image Analysis</h1>
    <p class="text-lg text-gray-500 mb-8">Upload an image, provide a prompt, select a model, and stream the visual analysis.</p>

    <form id="image-form" class="space-y-8" method="POST" enctype="multipart/form-data">
      
      <!-- Drag & Drop Upload with Preview -->
      <div>
        <label class="block text-lg font-semibold mb-2">Upload Image:</label>
        <label for="image" class="block border-2 border-dashed rounded-lg p-8 text-center text-gray-500 cursor-pointer hover:border-gray-400 relative">
          <template x-if="imagePreview">
            <img :src="imagePreview" alt="Preview" class="absolute inset-0 w-full h-full object-contain rounded-md" />
          </template>
          <template x-if="!imagePreview">
            <div>
              <svg class="mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" width="40" height="40">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4-4m0 0l-4 4m4-4v12" />
              </svg>
              <span class="block font-medium text-base">Drag & drop an image or click to upload</span>
              <span class="block text-sm">Supported: .jpg, .jpeg, .png, .gif (‚â§25MB)</span>
            </div>
          </template>
          <input type="file" id="image" name="image" accept="image/*" class="hidden" 
            @change="const file = $event.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = () => imagePreview = reader.result; reader.readAsDataURL(file); }" />
        </label>
      </div>

      <!-- Image Prompt -->
      <div>
        <label for="image_prompt" class="block text-lg font-semibold mb-2">Describe what you want to know about this image:</label>
        <textarea id="image_prompt" name="image_prompt" rows="3" placeholder="e.g. What are the objects in this photo?"
          class="w-full p-4 border rounded-lg text-base"></textarea>
      </div>

      <!-- Model Selector -->
      <div>
        <label class="block text-lg font-semibold mb-2">Select Model:</label>
        <div class="flex flex-wrap gap-4">
          {% for model in allowed_image_models %}
          <label
            :class="selected === '{{ model }}' ? 'border-2 border-gray-400 bg-gray-100' : 'border border-gray-300'"
            class="rounded-lg p-4 flex-1 cursor-pointer hover:bg-gray-50 transition-all"
            @click="if (!disabled) selected = '{{ model }}'">
            <input type="radio" name="image_model" value="{{ model }}" class="sr-only" :checked="selected === '{{ model }}'" />
            <div class="font-semibold text-lg">{{ model | capitalize }}</div>
            <div class="text-sm text-gray-500">Ollama Image Model</div>
          </label>
          {% endfor %}
        </div>
        <input type="hidden" name="image_model" :value="selected">
      </div>

      <!-- Analyze Button -->
      <button type="submit" id="analyze-button"
        class="w-full bg-gray-700 hover:bg-gray-800 text-white font-semibold text-lg py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
        :disabled="false">
        Analyze
      </button>
    </form>

    <!-- Streaming Results -->
    <div id="image-results" class="mt-10 space-y-4"></div>
  </main>

  <script>
    document.getElementById("image-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = document.getElementById("image-form");
      const formData = new FormData(form);
      const imageModel = formData.get("image_model");
      const resultsDiv = document.getElementById("image-results");

      resultsDiv.innerHTML = `
        <div class="card border rounded-lg shadow">
          <div class="p-4 border-b font-semibold">Response from ${imageModel}</div>
          <div class="p-4 text-base text-gray-800" id="image-response">Loading...</div>
        </div>`;

      fetch("/analyze-image", {
        method: "POST",
        body: formData
      }).then(async (res) => {
        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let responseText = "";
        const responseEl = document.getElementById("image-response");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          responseText += chunk;
          responseEl.textContent = responseText;
        }
      }).catch((err) => {
        document.getElementById("image-response").textContent = `‚ùå Error: ${err}`;
      });
    });
  </script>
</body>
</html>
